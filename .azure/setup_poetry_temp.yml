parameters:
- name: poetry_lock_file
  type: string
  default: 'poetry.lock'

steps:
  - task: UsePythonVersion@0
    displayName: "Use python $(python.version)"
    inputs:
      versionSpec: "$(python.version)"

  - script: |
      curl -sSL https://install.python-poetry.org | python -
    displayName: "Install poetry"  

  - task: PipAuthenticate@1
    displayName: 'Pip Authenticate'
    inputs:
      artifactFeeds: feed_fund
      onlyAddExtraIndex: True

  - script: |
      python -m pip install --upgrade pip
      python -m pip install mds-dev
      poetry config repositories.azure https://pkgs.dev.azure.com/dcimds/_packaging/feed_fund/pypi/simple
      poetry config http-basic.azure build $(System.AccessToken)
      # We force lock update because the files on Azure cloud lose their timestamps
      test -d .git || cd interop && mds-dev lock --force && mds-dev install
      test -d .git && mds-dev lock --force && mds-dev install
    displayName: "Bootstrap mds-dev and install poetry env"

