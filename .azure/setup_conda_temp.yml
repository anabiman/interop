parameters:
- name: conda_env_dir
  type: string
  default: $(CONDA_ENV_DIR)
- name: conda_lock_file
  type: string
  default: 'conda-lock.yml'

steps:
  - task: UsePythonVersion@0
    displayName: "Use python $(python.version)"
    inputs:
      versionSpec: "$(python.version)"

  - task: Cache@2
    displayName: "Cache conda packages"
    inputs:
      key: 'conda | $(Agent.OS) | ${{ parameters.conda_lock_file }}'
      path: ${{ parameters.conda_env_dir }}
      cacheHitVar: CACHE_RESTORED

  - script: |
      conda config --add envs_dirs ${{ parameters.conda_env_dir }}
    displayName: "Configure conda env dir"

  - script: |
      conda install --channel=conda-forge --name=base conda-lock -y
    displayName: "Install conda-lock"  
    condition: ne(variables.CACHE_RESTORED, 'true')

  - task: PipAuthenticate@1
    displayName: 'Pip Authenticate'
    inputs:
      artifactFeeds: feed_fund
      onlyAddExtraIndex: True

  - script: |
      python -m pip install --upgrade pip
      python -m pip install mds-dev
      # We force lock update because the files on Azure cloud lose their timestamps
      test -d .git || cd interop && mds-dev lock --force && mds-dev install
      test -d .git && mds-dev lock --force && mds-dev install
    displayName: "Bootstrap mds-dev and install conda env"
    condition: ne(variables.CACHE_RESTORED, 'true')


